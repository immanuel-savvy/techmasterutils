let express,cors,bodyParser,domain,remove_file,save_file,PDFNet;_6b9‍.w("express",[["default",["express"],function(v){express=v}]]);_6b9‍.w("cors",[["default",["cors"],function(v){cors=v}]]);_6b9‍.w("body-parser",[["default",["bodyParser"],function(v){bodyParser=v}]]);_6b9‍.w("./utils",[["domain",["domain"],function(v){domain=v}],["remove_file",["remove_file"],function(v){remove_file=v}],["save_file",["save_file"],function(v){save_file=v}]]);_6b9‍.w("@pdftron/pdfnet-node",[["PDFNet",["PDFNet"],function(v){PDFNet=v}]]);





process.on("uncaughtException", function (error) {
  _6b9‍.g.console.log(error.stack);
});

let main = async (input, output) => {
  try {
    await PDFNet.addResourceSearchPath("./");

    if (!(await PDFNet.StructuredOutputModule.isModuleAvailable())) {
      return;
    }

    await PDFNet.Convert.fileToWord(input, output);
  } catch (e) {}
};

process.on("uncaughtException", function (error) {
  _6b9‍.g.console.log(error.stack);
});

const app = express();
app.use(cors());
app.use(express.static(__dirname + "/files"));
app.use(bodyParser.urlencoded({ extended: true, limit: "100mb" }));
app.use(bodyParser.json({ limit: "100mb" }));

app.get("/", (req, res) => res.send("<div><h1>Hi, its Techmaster.</h1></div>"));

app.get("/what_is_my_ip", (req, res) => {
  let ip =
    (req.headers["x-forwarded-for"] || "").split(",").pop().trim() ||
    req.connection.remoteAddress ||
    req.socket.remoteAddress ||
    req.connection.socket.remoteAddress;

  res.status(200).json({ ok: true, message: "your ip address", data: { ip } });
});

app.post("/upload_to_remote_server", (req, res) => {
  let { file } = req.body;
  let saved_file = save_file(file, ".pdf");
  let input_file_url = `${domain}/${saved_file}`;

  res.json({
    ok: true,
    message: "file uploaded",
    data: { filename: saved_file, url: input_file_url },
  });
});

app.post("/pdf_to_word", (req, res) => {
  let { file } = req.body;

  let saved_file = save_file(file, ".pdf");
  let input_file_path = `./files/${saved_file}`;
  let out_filename = `${saved_file.slice(0, saved_file.indexOf("."))}.docx`;
  let output_file_path = `./files/${out_filename}`;

  try {
    PDFNet.runWithCleanup(
      () => main(input_file_path, output_file_path),
      "demo:1674987060797:7d5a1d8903000000002893e91db12901081a7713aa7f43e4b54cfdace1"
    )
      .catch((e) => {})
      .then((r) => {
        remove_file(saved_file);
        res.json({
          ok: true,
          data: {
            file_name: out_filename,
            url: `${domain}${output_file_path.slice(7)}`,
          },
        });

        setTimeout(() => remove_file(out_filename), 10 * 1000 * 60);
      });
  } catch (e) {}
});

app.listen(3300, () => {
  console.log("Techmaster Utils Backend started on :3300");
});
